<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;sshpass&quot;&gt;&lt;a href=&quot;#sshpass&quot; class=&quot;headerlink&quot; title=&quot;sshpass&quot;&gt;&lt;/a&gt;sshpass&lt;/h2&gt;&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install sshpass&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;使用方法（3种）&quot;&gt;&lt;a href=&quot;#使用方法（3种）&quot; class=&quot;headerlink&quot; title=&quot;使用方法（3种）&quot;&gt;&lt;/a&gt;使用方法（3种）&lt;/h3&gt;&lt;p&gt;1 . 直接用密码"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>文件传输工具(Linux) | Phylee的小站</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Linux/" rel="tag">Linux</a></div><div class="post-time">2017-07-07</div></div></div><div class="container post-header"><h1>文件传输工具(Linux)</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#sshpass"><span class="toc-number">1.</span> <span class="toc-text">sshpass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用方法（3种）"><span class="toc-number">1.2.</span> <span class="toc-text">使用方法（3种）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rysnc"><span class="toc-number">2.</span> <span class="toc-text">rysnc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注意目录后斜杠“-”"><span class="toc-number">2.1.</span> <span class="toc-text">注意目录后斜杠“&#x2F;”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rysnc为何传输速度快？"><span class="toc-number">2.2.</span> <span class="toc-text">rysnc为何传输速度快？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#scp-（可搭配expect）"><span class="toc-number">3.</span> <span class="toc-text">scp （可搭配expect）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#expect是一个用来处理交互的命令"><span class="toc-number">3.1.</span> <span class="toc-text">expect是一个用来处理交互的命令</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="sshpass"><a href="#sshpass" class="headerlink" title="sshpass"></a>sshpass</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass</span><br></pre></td></tr></table></figure>

<h3 id="使用方法（3种）"><a href="#使用方法（3种）" class="headerlink" title="使用方法（3种）"></a>使用方法（3种）</h3><p>1 . 直接用密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p 'host_pass' ssh user@host_ip 'df -h'</span><br><span class="line">sshpass -p 'host_pass' scp -r root@host_ip:/home/test/ ./tmp/</span><br></pre></td></tr></table></figure>

<p>首次连接需要加参数-o StrictHostKeyChecking=no, 否则return code是6 ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p 'host_pass' ssh  -o StrictHostKeyChecking=no  user@host_ip 'df -h'</span><br></pre></td></tr></table></figure>

<p>2 . 使用环境变量保存密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export SSHPASS='host_pass'</span><br><span class="line">sshpass -e ssh user@host_ip 'df -h'</span><br></pre></td></tr></table></figure>

<p>3 . 使用文件保存密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -f password_filename ssh user@host_ip 'df -h'</span><br></pre></td></tr></table></figure>

<h2 id="rysnc"><a href="#rysnc" class="headerlink" title="rysnc"></a>rysnc</h2><p>快速，增量的文件传输工具。支持本地和远程文件传输。</p>
<h3 id="注意目录后斜杠“-”"><a href="#注意目录后斜杠“-”" class="headerlink" title="注意目录后斜杠“/”"></a>注意目录后斜杠“/”</h3><p>rsync 遵循 BSD cp 的约定, 源目录后面带有一个斜杠“/”有着特定的处理。<br>比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -r source destination</span><br></pre></td></tr></table></figure>

<p>创建一个有着 “source”内容的 “destination/source”目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -r source/ destination</span><br></pre></td></tr></table></figure>

<p>把”source/“目录下的所有文件全部复制到”destination”目录下，而没有中间的子目录, 就像你调用了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -r source/. destination</span><br></pre></td></tr></table></figure>

<p>这与 GNU cp 的行为是不同的，在GNU cp中”source” 与 “source/“ 意义相同 (不是”source/.”)。此外，一些shell可以在你键入Tab补全的时候自动自动给目录追加尾部下划线。需要注意自身的使用场景，避免这种细节上的错误。</p>
<h3 id="rysnc为何传输速度快？"><a href="#rysnc为何传输速度快？" class="headerlink" title="rysnc为何传输速度快？"></a>rysnc为何传输速度快？</h3><p>无论是本地或远程文件传输， rsync 首先创建每个源文件块校验的索引。此索引用于查找可能存在于目标中的任何相同数据块。一旦这种块存在，块就被就地使用，而不是从源复制。这大大加快了存在小差异的大文件的同步</p>
<h2 id="scp-（可搭配expect）"><a href="#scp-（可搭配expect）" class="headerlink" title="scp （可搭配expect）"></a>scp （可搭配expect）</h2><h3 id="expect是一个用来处理交互的命令"><a href="#expect是一个用来处理交互的命令" class="headerlink" title="expect是一个用来处理交互的命令"></a>expect是一个用来处理交互的命令</h3><p>expect中四个常用命令是send,expect,spawn,interact。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">send：用于向进程发送字符串</span><br><span class="line">expect：从进程接收字符串</span><br><span class="line">spawn：启动新的进程</span><br><span class="line">interact：允许用户交互</span><br></pre></td></tr></table></figure>

<p>Example: 如下脚本autoscp.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/expect</span></span><br><span class="line">set user [lindex $argv 0]</span><br><span class="line">set ip [lindex $argv 1]</span><br><span class="line">set passwd [lindex $argv 2]</span><br><span class="line">set srcfile [lindex $argv 3]</span><br><span class="line">set dstdir [lindex $argv 4]</span><br><span class="line"></span><br><span class="line">set timeout 20</span><br><span class="line">spawn scp $srcfile $user@$ip:$dstdir</span><br><span class="line">expect &#123;</span><br><span class="line">"yes/no)?" &#123; send "yes\r";puts "yes" &#125;</span><br><span class="line">"assword:" &#123; send "$passwd\r" &#125;</span><br><span class="line">timeout &#123; puts "$IP time out" ;exit 1 &#125;</span><br><span class="line">&#125;</span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure>

<p>注意点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 . &#x2F;usr&#x2F;bin&#x2F;expect就是 which expect 的路径</span><br><span class="line">2 . 脚本需要执行权限。 chmod +x autoscp.sh</span><br><span class="line">3 . 执行脚本是.&#x2F;autoscp.sh, 不是 sh autoscp.sh。否则会报一些命令not found。</span><br><span class="line">    因为该脚本用的并不是bash,脚本第一行已经写明。</span><br><span class="line">4 . expect中执行命令是有一个timeout的设定的，默认超时时间为10s。</span><br><span class="line">    若一条命令未timeout限定时间内执行完，就会中断该条命令的下一条命令。</span><br><span class="line">    在expect脚本中设定timeout，可覆盖原本的timeout.</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>